version: '2'

services:
  mongodb:
    volumes:
      - progdash-mongo-data:/data/db
      - progdash-mongo-config:/data/configdb
    ports:
      - 27017:27017

  mongoadmin:
    ports:
      - 8081:8081

  java:
    image: rancher-registry.woonoz.com:5000/woonoz/progdash-java:${DOCKER_TAG}
    container_name: progdash-java
    build:
      context: ./
      dockerfile: ./build/dockerfiles/java/Dockerfile
    environment: &mongo_env
      TZ: Europe/Paris
      DB_USER: ${DB_USER}
      DB_PWD: ${DB_PWD}
      MONGO_PROGDASH_DB: ${MONGO_PROGDASH_DB}
      MONGO_PROGDASH_USER: ${MONGO_PROGDASH_USER}
      MONGO_PROGDASH_PASS: ${MONGO_PROGDASH_PASS}
    command: >
      /bin/bash -c "envsubst < /opt/progdash/application.properties > /opt/progdash/application.properties
      && /usr/bin/java -jar /opt/progdash/webservices.jar --spring.config.location=/opt/progdash/application.properties"
    depends_on:
      - mongodb
    links:
      - mongodb:mongo
    ports:
      - 8080:8080

  nginx:
    image: rancher-registry.woonoz.com:5000/woonoz/progdash-nginx:${DOCKER_TAG}
    container_name: progdash-nginx
    build:
      context: ./
      dockerfile: ./build/dockerfiles/nginx/Dockerfile
    depends_on:
      - java
    links:
      - java
    environment:
      TZ: Europe/Paris
    ports:
      - 8090:80

volumes:
  progdash-mongo-data:
    driver: local
  progdash-mongo-config:
    driver: local
  progdash-mongo-backup:
    driver: local